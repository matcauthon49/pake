\section{Security of the Cramer--Shoup Encryption Scheme with Delayed Reveal of the Secret Key}
\label{appendix-a}

In this section we prove the delayed-reveal-CCA-security of the Cramer--Shoup encryption scheme. We first start by formally defining the delayed-reveal-CCA game.

\subsection{Security Against Delayed-Reveal Chosen Ciphertext Attack}

\begin{figure}[ht!]
	\begin{framed}\small
		\textbf{Stage 1:} The adversary queries a \textit{key generation oracle}. The key generation oracle computes $(\PK,\SK)\leftarrow\PKE.\keygen(1^\lambda)$ and responds with $\PK$.
		
		\vspace{2mm}
		
		\textbf{Stage 2:} The adversary makes a sequence of calls to a decryption oracle. For each  decryption oracle query, the adversary submits a ciphertext $\psi$, and the decryption
		oracle responds with $\PKE.\dec(\SK,\psi)$.
		
		\vspace{2mm}
		
		\textbf{Stage 3:} The adversary submits two messages $m_0, m_1\in\PKE.\mathsf{MsgSpace}_{\lambda,\PK}$ to an encryption oracle. We require that $|m_0| = |m_1|$.
		
		On input $(m_0, m_1)$, the encryption oracle computes $$b\rgets\{0,1\};\psi^*\gets\PKE.\enc(\PK,m_b)$$ and responds with the target ciphertext $\psi^{*}$.
		
		\vspace{2mm}
		
		\textbf{Stage 4:} The adversary continues to make calls to the decryption oracle, subject only to the restriction that a submitted ciphertext $\psi$ is not equal to $\psi^{*}$.
		
		\vspace{2mm}
		
		\textbf{Stage 5:} The adversary submits a $\mathsf{halt}$ statement to an \textit{auxilliary oracle}, which responds with some auxiliary information $\mathsf{aux}$. From this point on the adversary no longer has access to the decryption oracle, and is not able to make any further queries.
		
		\vspace{2mm}
		
		\textbf{Stage 6:} The adversary outputs $\hat{b}\in\{0,1\}$.
	\end{framed}
	\caption{The Delayed-Reveal-CCA game with auxiliary information $\mathsf{aux}$.}
	\label{fig:dcca}
\end{figure}

We define the delayed-reveal-CCA advantage with auxiliary information $\aux$ of the adversary $\adv$ against $\PKE$, denoted as $\drcca(\lambda)$, to be $2|\Pr[\hat{b} = b] - 1/2|$ in the attack game in \cref{fig:dcca} with corresponding value of $\aux$. % Informally, we say that a public-key encryption scheme is delayed-reveal-CCA secure with auxiliary information $\aux$ if the probability that $b = \hat{b}$ is negligible, ie. the adversary is able to correctly guess which message was encrypted with no more than negligible probability. This leads to the formal definition as below.

\begin{definition}[Security Against Delayed-Reveal-Chosen Ciphertext Attack (DR-CCA)]
	Let $\PKE$ be any public-key encryption scheme. We say that $\PKE$ is delayed-reveal-CCA-secure with auxiliary information $\aux$ if there exists some negligible function such that for all $\lambda\in\Z_{\geq 0}$, $$\drcca(\lambda)\leq\negl(\lambda).$$
\end{definition}
Note that standard CCA-security is a special case of DR-CCA-security with auxiliary information $\mathsf{aux} = \bot$.

With this in hand, we can now formally state the theorem.

\begin{theorem}
	\label{thm:drcca-cs}
	If the DDH and the DSDH assumptions hold for $\mathcal{G}$ and the hash function $H$ is collision-resistant, then the Cramer--Shoup encryption scheme with labels (\cref{fig:cs03}) is DR-CCA-secure with auxiliary information $\aux = (x_1,x_2,y_1,y_2,g_1^{r^2},g_2^{r^2},(h^r\cdot m_b)^{r},(cd^{\alpha})^{r^2})$.
\end{theorem}

\subsection{Analysis of DR-CCA Security of the Cramer--Shoup Encryption Scheme}

\subsubsection{Overview}

Our argument proceeds very closely to the proof of the (standard) CCA-security of the Cramer--Shoup encryption scheme \cite[Section~6.2]{cs01}. The argument follows a series of games starting at game $\game_0$, which corresponds to the actual attack, and ending at $\game_8$, which is a game in which the ciphertext returned to the adversary is completely independent of the hidden bit $b$. In each game, $b$ takes on identical values. We now define a few helpful variables to quantify the adversary's advantage in each game. Let $T_i$ be the event in game $\game_i$ that $\hat{b}=b$. We will show for each game that $|\Pr[T_{i+1}] - \Pr[T_i]]$ is negligible. Game $\game_8$, which is completely independent of $b$, naturally has probability $\Pr[T_8]=1/2$, because in this game the adversary can do no better than a coin toss. We also introduce the variable $\drcca_i(\lambda)$ to represent the \textit{advantage} of the adversary in game $\game_i$, which is defined as $2|\Pr[T_i]-1/2|$. Ultimately our goal is to show that $\drcca_0(\lambda)\leq\negl(\lambda)$.

The probability is taken over the following mutually independent random variables:	\begin{enumerate}
	\item The internal coin tosses of $\adv$.
	\item The values $\hk,w,x_1,x_2,y_1,y_2,z_1,z_2$ generated independently by the key generation algorithm.
	\item The values $b\in\{0,1\}$ and $r\in\Z_q$ which are generated by the encryption oracle.
\end{enumerate}

\paragraph{Outline of hybrids.} Before continuing formally, we outline a brief sketch of each of the games.

\begin{itemize}
	\item In game $\game_1$ we make some technical changes to the encryption algorithm which have no effect on the adversary's view. After game $\game_5$, the randomness $r$ will be largely meaningless and thus cannot be used for correct encryption. This game ensures that encryption can occur without using $r$.
	\item Game $\game_2$ moves part of the auxiliary information, $\aux_1 =(g_1^{r^2}, g_2^{r^2},(h^r\cdot m_i)^{r},(cd^{\alpha})^{r^2})$ as an output of the decryption oracle. This can only increase the power of the adversary, since it is also allowed to make decryption oracle queries that involve the auxiliary information.
	\item Game $\game_3$ replaces $x^{r^2}$ with random values, which follows from DSDH. It shows that the auxiliary information $\aux_1$ has negligible effect on the adversary's advantage.
	\item Game $\game_4$ is a technical game that completes the argument of $\game_3$.
	\item Game $\game_5$ replaces $u_2$ with a random value, which follows from DDH. This breaks the correlation between $u_1, u_2$ and $h^r\cdot m_b$, allowing $m_b$ to be replaced by a completely random value in future games.
	\item Game $\game_6$ is really the core of the proof. In this game the decryption oracle is modified so that it additionally checks whether $u_2$ is indeed $g_2^r$ for some $r$. The indistinguishability of this game from the previous one follows from the fact that the adversary cannot with any nontrivial probability submit a valid ciphertext which does not carry the correlation $(g_1, g_2, h)$ that is given by the public key. In particular, note that $\game_5$ ensures that the target ciphertext $\psi^{*}$ does \textit{not} have that particular correlation. The immediate implication is that the adversary cannot with any nontrivial probability modify the target ciphertext $\psi^{*}$ in such a way that obtains even a different, valid ciphertext, let alone one that provides information about $m_b$. However, the argument of indistinguishability is nontrivial and spreads across more games.
	\item In game $\game_7$, $m_b$ is replaced by a uniformly random value. We will show that both the advantage difference in this game, and the probability that the adversary is able to come up with some ``bad'' ciphertext which could have potentially provided information about $m_b$, are negligible.
	\item Finally, game $\game_8$ bounds the probability of a ``bad'' ciphertext by modifying the decryption oracle, which now rejects if the adversary is able to reuse the MAC part $v$ of the ciphertext. The indistinguishability argument shows that if the adversary could make this query, then it either (a) broke the hash function, or (b) made an extremely unlikely guess, which it simply does not have enough information to with any nontrivial probability.
\end{itemize}

\subsubsection{Proof of \cref{thm:drcca-cs}}

\paragraph{Notation.} We first describe some helpful notation, most of which is borrowed from \cite{cs01}. Let $\adv$ be the DR-CCA adversary. Recall that the public key in Cramer--Shoup is $(\Gamma[\G,g,q],\hk,g_1, g_2, c,d,h)$ where $g_1 = g$, and that the secret key is $(\Gamma,\hk,x_1,x_2,y_1,y_2,z_1,z_2)$. Let $w:=\log_{g}g_2$ and define $x,y,z$ as follows: $$x:=x_1+x_2w, y:= y_1+y_2w, z:= z_1+z_2w.$$ In particular, $x=\log_{g}c$, $y=\log_gd$ and $z=\log_g h$.

When we deal with ciphertext $\psi$, we also define the following values:
\begin{itemize}
	\item $u_1,u_2,e',e,v\in\G$, where $\psi = (u_1,u_2,e,v)$, with $h = u_1^{z_1}u_2^{z_2}$.
	\item $r,\hat{r} = \log_gu_2, \alpha, r_e = \log_ge, r_v = \log_g d$, and $t = x_1r + y_1r\alpha + x_2\hat{r}w + y_2\hat{r}\alpha w$.
\end{itemize}

For the target ciphertext $\psi^{*}$, we denote each of the variables with a $*$, i.e., the corresponding values are $u_1^{*}, u_2^{*}, (e')^*, e^{*}, v^{*}, r^{*},\hat{r}^{*}, \alpha^{*}, r_e^{*}, r_v^{*}, t^{*}$.

\paragraph{Hybrids.} We now proceed to describe the games in detail. Game $\game_0$ is the original DR-CCA game.

\textbf{Game $\game_1$.} This game is the same as $\game_1$ of \cite{cs01}. 

We modify game $\game_0$ to obtain the new game, which is identical except for a small modification to the encryption oracle. Instead of using the encryption algorithm as given to compute the target ciphertext $\psi^{*}$, we use a modified encryption algorithm, in which the steps $\estep{4}$ and $\estep{7}$ (see \cref{fig:cs03}) are replaced by 
\begin{itemize}
	\item[] $\estep{4}': e' := u_1^{z_1}u_2^{z_2}$. 
	\item[] $\estep{7}': v := u_1^{x_1+y_1\alpha}u_2^{x_2+y_2\alpha}$.
\end{itemize}
These changes are purely conceptual and the values of $(e')^*$ and $v^{*}$ are exactly the same in both games. It follows that $$\Pr[T_0]=\Pr[T_1].$$

\textbf{Game $\game_2$.} This game is identical to $\game_1$ with the following modification. We modify the encryption oracle in Stage $3$ such that along with the target ciphertext $\psi^{*}$, it also outputs the auxiliary information $\aux_1 = (g_1^{r^2}, g_2^{r^2},(h^r\cdot m_b)^{r},(cd^{\alpha})^{r^2}) = ((u_1^*)^r, (u_2^*)^r, (e^*)^r, (v^*)^r)$. Furthermore, we also modify the auxiliary oracle such that it no longer outputs the previous string, instead outputting only $\aux_2 = (x_1,x_2,y_1,y_2)$. 

Our analysis of this game is simple. Note that by providing $\adv$ the values $(g_1^{r^2}, g_2^{r^2},(h^r\cdot m_b)^{r},(cd^{\alpha})^{r^2})$ \textit{before} it can no longer make decryption oracle queries, we can only increase $\adv$'s power (and hence advantage). It follows that $\drcca_1(\lambda)\leq\drcca_2(\lambda)$. Rephrasing, we can see that $$\Pr[T_1]\leq\Pr[T_2].$$

\textbf{Game $\game_3$.} In this game we again modify the encryption oracle in Stage 3. Instead of outputting the target ciphertext $(\psi^{*}, \aux_1) = ((u_1^{*}, u_2^{*}, e^{*}, v^{*}), (g_1^{r^2}, g_2^{r^2},(h^r\cdot m_b)^{r},(cd^{\alpha})^{r^2}))$, the oracle samples $s \rgets \mathbb{Z}_{q}$ and outputs $(\psi^{*}, \aux_1) = ((u_1^{*}, u_2^{*}, e^{*}, v^{*}), (g_1^{s}, g_2^{r^2},(h^r\cdot m_b)^{r},(cd^{\alpha})^{r^2}))$. 

Recall that $g_1 = g$ and $u_1^* = g_1^r$, so the only difference between the games $\game_2$ and $\game_3$ is that the tuple $(u_1^*, \aux_1[0])$ is a uniformly distributed SDH tuple in $\game_2$ while it is a uniformly distributed tuple from $\mathbb{Z}_q^2$ in $\game_3$. It is thus immediately clear that the indistinguishability of the two games follows from the DSDH assumption. More specifically, we show the following.

\begin{lemma}
	\label{lem:sdh-game}
	There exists some PPT algorithm $\adv_\mathsf{DSDH}$ such that $$|\Pr[T_3]-\Pr[T_2]|\leq\mathsf{AdvDSDH}_{\adv_\mathsf{DSDH}, \mathcal{G}}(\lambda|\Gamma).$$
\end{lemma}
\begin{proof}
	We will describe $\adv_\mathsf{DSDH}$ in detail. The algorithm takes in as input some tuple $(g^a, g^{b})$, and interacts with the DR-CCA adversary $\adv$. First, it begins by computing
	$$\hk\rgets\mathsf{HF.Keyspace}_{\lambda, \Gamma}; w\rgets\Z^{*}_q; x_1,x_2,y_1,y_2,z_1,z_2\rgets\Z_q; c := g^{x_1+wx_2}; d := g^{y_1+wy_2}; h := g^{z_1+wz_2}.$$
	Using the above, it generates a public key $\PK = (\Gamma, \hk, g,g^w, c, d, h)$ and a secret key $\SK = (\Gamma,\hk,x_1,x_2,y_1,y_2,z_1,z_2)$, and passes $\PK$ to $\adv$. We now show the behaviour of $\adv_\mathsf{DSDH}$ on encryption and decryption queries. Whenever it receives a ciphertext of the form $\psi = (u_1,u_2,e,v)$ to the decryption oracle, it uses $\SK$ to decrypt and outputs either $\bot$ or some $m$. When $\adv$ submits $(m_0,m_1)$ to the encryption oracle, $\adv_\mathsf{DSDH}$ samples $b\rgets\{0,1\}$ and computes
	$$u_1^{*} := g^a; u_2^{*} := (g^a)^w; e^{*} := (u_1^{*})^{z_1}(u_2^{*})^{z_2}\cdot m_b; v^{*} :=\mathsf{HF}_{\hk}^{\lambda,\Gamma}(u_1^{*},u_2^{*},e^{*}); v^{*} := (u_1^{*})^{x_1+v^{*}y_1}(u_2^{*})^{x_2+v^{*}y_2}$$ and outputs the ciphertext-auxiliary information pair $(\psi^{*},\aux_1) := ((u_1^{*},u_2^{*},e^{*},v^{*}), (g^{b}, (g^{b})^w,(e^*)^2), (v^*)^2)$. On input $\mathsf{halt}$ to the auxiliary oracle, $\adv_\mathsf{DSDH}$ outputs $(x_1,x_2,y_1,y_2)$.
	
	When $\adv$ outputs bit $\hat{b}$, $\adv_\mathsf{DSDH}$ outputs $1$ if $\hat{b} = b$ and $0$ otherwise. It is clear from the above simulation that for any fixed $\lambda$ and $\Gamma$, 
	\begin{align*}
		\Pr[T_2] &= \Pr[\adv_\mathsf{DSDH}(g^a,g^b) = 1 : a\rgets\Z_q, b := a^2]\\
		\Pr[T_3] &= \Pr[\adv_\mathsf{DSDH}(g^a,g^b) = 1 : a,b\rgets\Z_q].
	\end{align*}
	It immediately follows that 
	$$|\Pr[T_3]-\Pr[T_2]|\leq\mathsf{AdvDSDH}_{\adv_\mathsf{DSDH}, \mathcal{G}}(\lambda|\Gamma).\eqno\qedhere$$
\end{proof}

\textbf{Game $\game_4$.} We modify the encryption algorithm in Stage 3 again. Instead of outputting the ciphertext $(\psi^{*}, \aux_1) = ((u_1^{*}, u_2^{*}, e^{*}, v^{*}), (g_1^{s}, g_2^{r^2},(h^r\cdot m_b)^{r},(cd^{\alpha})^{r^2}))$ as before, the oracle samples $s_1,s_2 \rgets \mathbb{Z}_{q}$ and outputs $(\psi^{*}, \aux_1) := ((u_1^{*}, u_2^{*}, e^{*}, v^{*}), (g_1^{s}, g_2^{s_1},(h^r\cdot m_b)^{r},(cd^{\alpha})^{s_2}))$. 

The proof essentially follows the same as that of the previous game, and can be omitted. The same can be applied to the SDH tuple $(g, h^r\cdot m_b, (h^r\cdot m_b)^r)$, which we also fix in this game (in this modified version, the adversary simply adjoins an $m_b$ factor to the $(g, h^r, h^{r^2})$ tuple). \xjy{What does the last sentence mean?}

\textbf{Game $\game_5$.} This is game $\game_2$ of the proof of \cite{cs01}. We modify the encryption oracle in Stage 3, replacing step $\estep{3}$ of the encryption algorithm with
\begin{itemize}
	\item[] $\estep{3}':$ $\hat{r}\rgets\Z_q\setminus\{r\}; u_2 := g_2^{\hat{r}}$.
\end{itemize}
In the games up to $\game_4$ we had $r^{*} = \hat{r}^{*}$, however in game $\game_5$ $r^{*}$ and $\hat{r}^{*}$ are independent of each other except that they cannot be equal. Note, however, that like in the previous game, we have a tuple $(g_2, u_1^{*}, u_2^{*})$ which in game $\game_4$ is uniform DH tuple while in game $\game_5$ is uniform tuple in $\G^3$. This leads to the following lemma, which says that any distinguisher for the two games immediately gives a distinguisher for the DDH instance.

\begin{lemma}
	There exists some PPT algorithm $\adv_\mathsf{DDH}$ such that $$|\Pr[T_5]-\Pr[T_4]|\leq\advddh_{\adv_\mathsf{DDH},\mathcal{G}}(\lambda | \Gamma).$$
\end{lemma}
\begin{proof}
	The proof of this lemma is borrowed from \cite{cs01} and follows the same broad argument as that of \cref{lem:sdh-game}. The DDH distinguisher $\adv_\mathsf{DDH}$ is initiated with a tuple $(g_2, u_1, u_2)\in\G^3$.
	
	The DR-CCA adversary $\adv$ is used in the same way as \cref{lem:sdh-game}, with the decryption and auxiliary oracles having the same description. The only difference is how the encryption oracle computes the target ciphertext. In this case, when $\adv_\mathsf{DDH}$ receives $(m_0,m_1)$, it samples $b\rgets\{0,1\}$ and computes
	$$e^{*} := (u_1^{*})^{z_1}(u_2^{*})^{z_2}\cdot m_b; v^{*} :=\mathsf{HF}_{\hk}^{\lambda,\Gamma}(u_1^{*},u_2^{*},e^{*}); v^{*} := (u_1^{*})^{x_1+v^{*}y_1}(u_2^{*})^{x_2+v^{*}y_2}.$$
	The auxiliary information $\aux_1$ is sampled in the same manner, with $g^s$ and $g^{s'}$ uniformly random elements of $\G$.
	
	When $\adv$ outputs bit $\hat{b}$, $\adv_\mathsf{DDH}$ outputs $1$ if $\hat{b} = b$ and $0$ otherwise. It is clear from the above simulation that for any fixed $\lambda$ and $\Gamma$, 
	\begin{align*}
		\Pr[T_4] &= \Pr[\adv_\mathsf{DDH}(g^a,g^b,g^c) = 1 : a,b\rgets\Z_q, c := ab],\\
		\Pr[T_5] &= \Pr[\adv_\mathsf{DDH}(g^a,g^b,g^c) = 1 : a,b\rgets\Z_q, c\rgets\Z_q\setminus\{ab\}].
	\end{align*}
	It immediately follows that 
	$$|\Pr[T_5]-\Pr[T_4]|\leq\mathsf{AdvDDH}_{\adv_\mathsf{DDH}, \mathcal{G}}(\lambda|\Gamma).\eqno\qedhere$$
\end{proof}


\textbf{Game $\game_6$.} This is game $\game_3$ of the proof of \cite{cs01}. In this game, we modify the decryption oracle by replacing steps $\dstep{4}$ and $\dstep{5}$ with:
\begin{itemize}
	\item[]$\dstep{4}'$: Test if $u_2 = u_1^w$ and $v = u_1^{x+y\alpha}$. Output $\mathsf{reject}$ and halt if this is not the case.
	\item[]$\dstep{5}'$: $h:= u_1^z$.
\end{itemize}
We first notice that the decryption oracle does not make any direct use of $x_i, y_i, z_i$. It is easy to see that the decryption oracle of game $\game_5$ correctly answers all queries that $\game_6$ does. However, it is possible that $\game_6$ may reject certain queries. Let $R_6$ be the event that there is some query which is asked to $\game_6$ which would have been answered correctly by $\game_5$, but is rejected by $\game_6$. Note that $\game_5$ and $\game_6$ are identical unless $R_6$ occurs, so $$|\Pr[T_6]-\Pr[T_5]|\leq\Pr[R_6]$$ and it suffices to bound $\Pr[R_6]$. This will be done in games $\game_7$ and $\game_8$.

%We recall the following, which is Lemma 4 in \cite{cs01}.
%
%\begin{lemma}
%	\label{lem:neg-wedge}
%	Let $U_1$, $U_2$ and $F$ be events defined on some probability space. Suppose that the event $U_1\wedge\neg F$ occurs iff $U_2\wedge\neg F$ occurs. Then $|\Pr[U_1]-\Pr[U_2]|\leq\Pr[F]$.
%\end{lemma}
%
%We will apply this lemma in our analysis. Note that the event $T_5\wedge\neg R_6$ and $T_6\wedge\neg R_6$ are identical. By the lemma, we get $$|\Pr[T_3]-\Pr[T_2]|\leq\Pr[R_3]$$ and it suffices to bound $\Pr[R_3]$. This will be done in games $\game_7$ and $\game_8$.

\textbf{Game $\game_7$.} This game is identical to $\game_6$, except that in this game the message encrypted in the target ciphertext is randomly selected instead of being $m_b$. In particular, we modify the encryption oracle and replace $\estep{5}$ with
\begin{itemize}
	\item[]$\estep{5}'$: $r'\rgets\Z_q$; $e := g^{r'}$.
\end{itemize}
It follows that $\Pr[T_7] = 1/2$, because now $b$ is not used anywhere in the game, so $\adv$'s output bit $\hat{b}$ is independent of it. We define event $R_7$ in $\game_7$ which is the same as $R_6$ in $\game_6$, i.e., some ciphertext $\psi$ is submitted to the decryption oracle which is rejected by $\dstep{4}'$ but would have passed $\dstep{4}$.

\begin{lemma} We have
	\label{lem:t6t7}
	\begin{align*}
		\Pr[T_6] &= \Pr[T_7],\\
		\Pr[R_6] &= \Pr[R_7].
	\end{align*}
\end{lemma}

Before we show the proof, we recall \cite[Lemma~9]{cs01}.

\begin{lemma}
	\label{lem:independence}
	Let $k,n$ be integers with $1\leq k\leq n$ and let $K$ be a finite field. Consider a probability space with random variables $\vec{\alpha}\in K^{n\times 1}, \vec{\beta}=(\beta_1,\dots,\beta_k)^\top\in K^{k\times 1},\vec{\gamma}\in K^{k\times 1}$, and $M\in K^{k\times n}$, such that $\vec{\alpha}$ is uniformly distributed over $K^{n\times 1}$, $\vec{\beta}=M\vec{\alpha}+\vec{\gamma}$, and for $1\leq i\leq k$, the $i$th rows of $M$ and $\gamma$ are determined by $\beta_1,\dots,\beta_{i-1}$. 
	
	Then conditioning on any fixed values of $\beta_1,\dots,\beta_{k-1}$ such that the resulting matrix $M$ has rank $k$, the value of $\beta_k$ is uniformly distributed over $K$ in the resulting probability space.
\end{lemma}
(We will actually require a less general version of this lemma in the proof below.)

\begin{proof}[Proof (of \cref{lem:t6t7})]
	Our proof is essentially the same as that of \cite{cs01}, however the presence of the auxiliary information requires a more subtle analysis.
	
	Consider the variable $X=(\mathsf{coins},\hk,w,x_1,x_2,y_1,y_2,b,r^{*},\hat{r}^{*})$, where $\mathsf{coins}$ is the internal randomness of $\adv$, and the quantity $z$ (recall that $z$ is defined as $z_1+z_2w$). Note that $X$ has the same values in $\game_6$ and $\game_7$.
	
	Consider also the quantity $r^{*}$, which takes different values in $\game_6$ and $\game_7$. We call these values $r_6^{*}$ and $r^{*}_7$ respectively. It is clear that both $R_6$ and $T_6$ are functions of $X,z$ and $r^{*}_6$. Also, the events $R_7$ and $T_7$ have the same functional dependence on $X,z$ and $r^{*}_7$. Thus, showing that the distributions
	$$(X, z, r^{*}_6)\cong(X, z, r^{*}_7)$$ is enough to show the lemma. Now observe that if $X$ and $z$ are fixed, $r^{*}_7$ is uniform over $\Z_q$. Furthermore, note that the uniformity of $r^{*}_7$ is \textit{completely} independent of $\aux = (x_1,x_2,y_1,y_2)$, since $e$ is completely independent of $\aux$ as well. Hence, knowledge of $\aux$ has no bearing on the independence of $r^{*}_7$, and it remains so even if $\aux$ is public.
	
	We now show that the same is true for $r^{*}_6$. Consider
	\begin{equation*}
		\begin{pmatrix}
			z\\
			r^{*}_6
		\end{pmatrix}=
		\begin{pmatrix}
			1 & w\\
			r^{*} & w\hat{r}^{*}
		\end{pmatrix}\cdot
		\begin{pmatrix}
			z_1\\
			z_2
		\end{pmatrix}+
		\begin{pmatrix}
			0\\
			\log_gm_{b}
		\end{pmatrix}.
	\end{equation*}
	\xjy{Why does the second line of the equation hold?} Let $M = \begin{pmatrix}
			1 & w\\
			r^{*} & w\hat{r}^{*}
		\end{pmatrix}$. Then $M$ is fixed conditioned on $X$, but $z_1$ and $z_2$ are independently distributed over $\Z_q$ (even in the knowledge of $\aux$). Furthermore, $\det(M) = w(\hat{r}^{*} - r^{*})\neq 0$ (recall that the change in $\game_5$ guarantees that $\hat{r}^* \neq r^*$). The lemma then follows from \cref{lem:independence}.
\end{proof}

\textbf{Game $\game_8$.} This game is the same as $\game_7$, with a small modification to the decryption oracle. We modify it so that it applies a special rejection rule: if $\adv$ submits a ciphertext $\psi$ for decryption at a point \textit{after} the encryption oracle has been invoked, such that $(u_1, u_2, e)\neq (u_1^{*}, u_2^{*}, e^{*})$ but $v = v^{*}$, then the decryption oracle outputs $\mathsf{reject}$ and halts even before executing $\dstep{4}'$.

We define two events:
\begin{enumerate}
	\item $C_8$, which is the event that $\adv$ submits a ciphertext which is rejected according to the special rule.
	\item $R_8$, which is that some ciphertext $\psi$ is submitted which passes the special rule, however it is rejected by $\dstep{4}'$, and would have been accepted by $\dstep{4}$.
\end{enumerate}

Note that games $\game_7$ and $\game_8$ are identical unless $C_8$ occurs, so
$$|\Pr[R_8]-\Pr[R_7]|\leq\Pr[C_8].$$

We will show two lemmas that complete the proof. The first lemma shows that the special rejection rule can be broken if the underlying hash is broken, while the second shows that breaking the rule without breaking the hash requires an information-theoretically unlikely guess.

\begin{lemma}
	\label{lem:hash}
	There is some probabilistic polynomial-time algorithm $\adv_\mathsf{HASH}$ such that $$\Pr[C_8]\leq\mathsf{AdvCRH}_{\mathsf{HF},\adv_\mathsf{HASH}}(\lambda|\Gamma).$$
\end{lemma}

\begin{lemma}
	\label{lem:bounding-r8}
	We have $$\Pr[R_8]\leq Q_\adv(\lambda)/q,$$
where $Q_\adv(\lambda)$ is number of $\adv$'s decryption oracle queries.
\end{lemma}
The proof of \cref{lem:hash} is identical to the proof of \cite[Lemma~7]{cs01} and is omitted. The proof of \cref{lem:bounding-r8} is also similar, yet must be adapted to our setting. 

\begin{proof}[Proof (of \cref{lem:bounding-r8}).]
	Consider the proof of \cite[Lemma~8]{cs01}. Both sub-parts of the proof rely on the fact that $\aux_2 = (x_1,x_2,y_1,y_2)$ is and uniformly distributed in $\adv$'s view, and independent of the rest of the game. Clearly this is not the case if $\aux_2$ is provided as auxiliary information. However, the proof only relies on the fact that $\aux_2$ be uniform and independent \textit{at the time the decryption query is made}. Indeed, by the definition of the DR-CCA game, it is clear that once the auxiliary oracle is queried, no more decryption queries are allowed to be made. Hence, at the time any decryption query is made, $\aux_2$ is uniform and independent, and the proof of \cite[Lemma~8]{cs01} follows without any additional concerns.
\end{proof}

In sum, we have shown that $|\Pr[R_8]-\Pr[R_6]|$ and $\Pr[R_8]$ are both negligible in $\lambda$, so $\Pr[R_6]$ is negligible in $\lambda$. This in turn implies that $|\Pr[T_0] - \Pr[T_7]|$ is negligible in $\lambda$; but $\Pr[T_7] = 1/2$, so $\drcca_0(\lambda) = 2|\Pr[T_0]-1/2|$ is negligible in $\lambda$. This completes the proof.